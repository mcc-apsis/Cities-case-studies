---
title: "City case studies"
output: 
  html_document: 
    df_print: paged
    fig_width: 5
    fig_height: 3.5
---

<hr>
#### Case studies have no distinct trend with city population size, although a few top global cities dominate the analysis
<br>

```{r include=FALSE}

rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- ctab %>%
  group_by(geo_city,geo_country,geo_pop) %>%
  summarise(n=n()) %>%
  arrange(desc(n)) %>%
  mutate(geo_pop=as.numeric(geo_pop))

ctop <- left_join(ctop,data_UN, by = c("geo_city" = "City")) %>%
  select(-c(Year,Country,Record.Type,Reliability,Value.Footnotes)) %>%
  group_by(geo_city) %>%
  filter(UN_pop==max(UN_pop) | is.na(UN_pop)==TRUE)

## use agglomeration data if we have it
ctop <- ctop %>%
  mutate(geo_pop=ifelse(UN_type=="Urban agglomeration" & is.na(UN_type)==FALSE,UN_pop,geo_pop))

ctop$population_category <- cut(ctop$geo_pop,breaks = c(100e6,10e6,1e6,3e5,0),dig.lab=10,include.lowest=TRUE)

blarg <- ctop %>%
  group_by(population_category,n==284,n==146,n==140,n==117,n==66,geo_pop==11789487,geo_pop==12576601,geo_pop==8307904,geo_pop==4246375,n==47,n==46,n==45,n==42,geo_pop==11071424,geo_pop==20116842) %>%
  summarise(no_cities=n(),mean_pop=mean(geo_pop),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(population_category))

blarg<- blarg %>%
  mutate(city_names=ifelse(nchar(blarg$city_names)>15,"Other",city_names))

ctop <- ctop %>%
  group_by(population_category) %>%
  summarise(no_cities=n(),mean_pop=mean(geo_pop),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>%
  ungroup() %>% arrange(desc(population_category))


```
```{r  studies_v_population, echo=FALSE, warning=FALSE, rows.print=4, fig.path='Plots/', dev=c('png','pdf')}

blarg %>%
  ggplot(.,aes(x=reorder(population_category,mean_pop),y=sum_articles,fill=city_names)) +
  geom_bar(stat="identity") +
  scale_x_discrete(labels = c("<0.3m","0.3-1m","1-10m",">10m")) +
  xlab("Cities, grouped by population") +
  ylab("Total articles")

library(knitr)
library(kableExtra)
kable(ctop, "html", caption="Urban studies versus population",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "200px")

```

```{r echo=FALSE,warning=FALSE, rows.print=4}

### Medium and small cities dominate population projections 


# data_proj %>%
#   filter(area=="WORLD",type=="Population",year>2010) %>%
#   arrange(-desc(size_code)) %>%
#   ggplot(.,aes(x=year,y=value,fill=size)) +
#   geom_bar(stat='identity') +
#   scale_fill_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m"))
# 
# 
# ### Case studies pretty well reflect the population projections
# 
# ctop$population_category <- factor(ctop$population_category, levels=rev(levels(ctop$population_category)))
# ctop %>%
#   mutate(Articles="") %>%
#   ggplot(.,aes(x=Articles,y=sum_articles,fill=population_category)) +
#   geom_bar(stat='identity') +
#   scale_fill_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m"))


```

#### Case studies regionally mis-match the population breakdown of cities

```{r include=FALSE}


rm(list = ls())
library(tidyverse)
library(svglite)
library(xlsx)

load(file = "Data/city_studies.RData")
load(file="Data/geo_data.RData")
load(file = "Data/city_data.RData")

region='UN6'

## use agglomeration data if we have it
ctab <- left_join(ctab,data_UN, by = c("geo_city" = "City")) %>%
  select(-c(Year,Country,Record.Type,Reliability,Value.Footnotes))

ctab <- ctab %>%
  mutate(geo_pop=ifelse(UN_type=="Urban agglomeration" & is.na(UN_type)==FALSE,UN_pop,geo_pop))


######### merge studies into regional breakdown of cities and populations ######### 

ctab$population_category <- cut(ctab$geo_pop,breaks=c(100e6,10e6,1e6,3e5,1),dig.lab=10,include.lowest=TRUE,ordered_result = TRUE)



ctab <- ctab %>%
  group_by_(region,'population_category') %>%
  summarise(no_studies=n(),study_cities=length(unique(geo_city)),citations=sum(citations,na.rm=TRUE)) %>%
  complete(population_category) %>% 
  ungroup()

ctab <- ctab %>%
  rbind(
    ctab %>% 
      group_by(population_category) %>%
      summarise(UN6="WORLD",no_studies=sum(no_studies,na.rm=TRUE),study_cities=sum(study_cities,na.rm=TRUE),
                citations=sum(citations,na.rm=TRUE)) %>%
      ungroup() %>%
      select(UN6,population_category,no_studies,study_cities,citations)
  ) %>%
  filter(!is.na(UN6))




# ## use agglomeration data if we have it
# data_geo <- left_join(data_geo,data_UN,by=c("city"="City")) %>%
#   select(-c(Year,Country,Record.Type,Reliability,Value.Footnotes))
# 
# data_geo <- data_geo %>%
#   mutate(pop=ifelse(UN_type=="Urban agglomeration" & is.na(UN_type)==FALSE,UN_pop,pop))
# 
# data_geo$population_category <- cut(data_geo$pop,breaks=c(100e6,10e6,1e6,3e5,1),dig.lab=10,include.lowest=TRUE,ordered_result = TRUE)
# 
# ## calculate regional population ratios
# data_geo <- data_geo %>%
#   group_by_(region) %>%
#   mutate(region_pop=sum(pop)) %>%
#   ungroup() %>%
#   group_by_(region,'population_category') %>%
#   summarise(geo_cities=n(),geo_city_names=paste(city, collapse=", "),geo_pop=sum(pop),geo_norm_pop=sum(pop)/mean(region_pop)) %>%
#   complete(population_category)
# 
# blarg <- left_join(ctab,data_geo)
# 
# ####################### Make 'world' a region ####################### 
# 
# world <- blarg %>%
#   group_by(population_category) %>%
#   summarise(geo_pop = sum(geo_pop,na.rm=TRUE),no_studies=sum(no_studies,na.rm=TRUE),citations=sum(citations,na.rm=TRUE))
# world[[region]] <- "WORLD"
# world <- world %>%
#   group_by_(region) %>%
#   mutate(total_studies=sum(no_studies),total_pop=sum(geo_pop),total_cites=sum(citations)) %>%
#   ungroup() %>%
#   mutate(study_norm=no_studies/total_studies,geo_norm_pop=geo_pop/total_pop,norm_citations=citations/total_cites) %>%
#   select(-c(total_studies,total_pop,total_cites))
# 
# blarg <- full_join(blarg,world)

####################### 

data_proj$area <- gsub("LATIN AMERICA AND THE CARIBBEAN","LATIN AMERICA",data_proj$area)
data_proj$area <- gsub("NORTHERN AMERICA","NORTH AMERICA",data_proj$area)

data_proj <- data_proj %>%
  filter(area=="WORLD" | area=="AFRICA" | area=="ASIA" | area=="EUROPE" | area=="LATIN AMERICA" | area=="NORTH AMERICA" | area=="OCEANIA")

data_proj <- data_proj %>% 
  filter(size_code %in% c(1,6)) %>% 
  mutate(size=ifelse(size_code==1,"(10000000,100000000]",size)) %>%
  mutate(size=ifelse(size_code==6,"[1,300000]",size)) %>%
  rbind(
    data_proj %>%
      filter(size_code %in% c(2,3)) %>% 
      group_by(area,year,type) %>%
      summarise(value=sum(value)) %>% 
      ungroup() %>% 
      mutate(size_code=23,size="(1000000,10000000]") %>% 
      select(area,size,size_code,type,year,value)
  ) %>% 
  rbind(
    data_proj %>%
      filter(size_code %in% c(4,5)) %>% 
      group_by(area,year,type) %>%
      summarise(value=sum(value)) %>% 
      ungroup() %>% 
      mutate(size_code=45,size="(300000,1000000]") %>% 
      select(area,size,size_code,type,year,value)
  ) %>%
  filter(type=="Population") %>% 
  select(-size_code,-type)
  
data_proj <- data_proj %>%
  mutate(value=value*1000) %>% 
  filter(year %in% c(2015,2030)) %>%
  spread(year,value) %>%
  set_names(c("area","size","popUN_2015","popUN_2030"))


### join

blarg <- left_join(ctab,data_proj,by=c("UN6"="area","population_category"="size"))



#### calculate ratios, global first

all_studies <- sum(blarg$no_studies[data_proj$area=="WORLD"])
world_pop_2015 <- sum(data_proj$popUN_2015[data_proj$area=="WORLD"])
world_pop_2030 <- sum(data_proj$popUN_2030[data_proj$area=="WORLD"])

blarg <- blarg %>%
  mutate(average_citations=citations/no_studies) %>%
  mutate(ratio_studies_global=no_studies/all_studies) %>%
  mutate(ratio_pop_2015_global=popUN_2015/world_pop_2015) %>%
  mutate(ratio_pop_2030_global=popUN_2030/world_pop_2030)

#### regional

blarg <- blarg %>% 
  group_by(UN6) %>% 
  mutate(region_pop_2015=sum(popUN_2015,na.rm=TRUE)) %>% 
  mutate(region_pop_2030=sum(popUN_2030,na.rm=TRUE)) %>% 
  mutate(region_studies=sum(no_studies,na.rm=TRUE)) %>%
  ungroup() %>% 
  mutate(ratio_studies_region=no_studies/region_studies) %>% 
  mutate(ratio_pop_2015_region=popUN_2015/region_pop_2015) %>% 
  mutate(ratio_pop_2030_region=popUN_2030/region_pop_2030) %>%
  select(-region_pop_2015,-region_pop_2030,-region_studies)


blarg$population_category <- as.factor(blarg$population_category)
blarg$population_category <- factor(blarg$population_category,levels(blarg$population_category)[c(4,3,1,2)])


```


```{r study_distribution, echo=FALSE,warning=FALSE, fig.width=12, fig.height=5,fig.path="Plots/",dev=c('png','pdf')}

####################### fraction of case studies and population (relative to region) #######################

blarg %>%
  ggplot(.) +
  geom_point(aes(x=UN6,y=ratio_studies_region),stat='identity',colour='blue') +
  geom_point(aes(x=UN6,y=ratio_pop_2015_region),stat='identity',colour='black') +
  geom_point(aes(x=UN6,y=ratio_pop_2030_region),stat='identity',colour='red') +
  geom_segment(aes(x=UN6,yend=ratio_studies_region+ifelse(ratio_studies_region>ratio_pop_2015_region,-0.015,0.015),xend=UN6,
                   y=ratio_pop_2015_region+ifelse(ratio_studies_region>ratio_pop_2015_region,0.015,-0.015)),arrow=arrow(length=unit(0.3,"cm"))) + 
  facet_grid(. ~ population_category) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("proportion of studies relative to urban inhabitats in each city size, by region (arrow going up = overrepresented)")


####################### average citations by region / city size #######################

blarg %>%
  ggplot(.,aes(x=population_category,y=average_citations,fill=UN6)) + 
  guides(fill=FALSE) +
  geom_bar(stat='identity') +
  facet_grid(reformulate(region)) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

####################### Case studies vs. population shares & projections #######################

# blarg %>%
#   mutate(ratio=ratio_studies_region/ratio_pop_2030_region) %>%
#   mutate(ratio=ifelse(ratio_studies_region<ratio_pop_2030_region,2-(ratio_pop_2030_region/ratio_studies_region),ratio)) %>% 
#   ggplot(.) +
#   geom_point(aes(x=population_category,y=ratio),stat='identity',colour='blue') +
#   facet_grid(.~ UN6)+
#   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

blarg %>%
  mutate(ratio=ratio_studies_global/ratio_pop_2030_global) %>%
  mutate(ratio=ifelse(ratio_studies_global<ratio_pop_2030_global,2-(ratio_pop_2030_global/ratio_studies_global),ratio)) %>% 
  ggplot(.) +
  geom_point(aes(x=population_category,y=ratio),stat='identity',colour='blue') +
  facet_grid(.~ UN6)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

# summary <- blarg %>% 
#   group_by(UN6) %>% 
#   summarise(total_cities=sum(geo_cities,na.rm=TRUE),total_study_cities=sum(study_cities,na.rm=TRUE),total_studies=sum(no_studies,na.rm=TRUE))


blarg$population_category <- as.factor(blarg$population_category)
blarg$population_category <- factor(blarg$population_category,levels(blarg$population_category)[c(4,3,1,2)])

data_proj$size <- as.factor(data_proj$size)
data_proj$size <- factor(data_proj$size,levels(data_proj$size)[c(4,3,1,2)])


data_proj %>%
  #gather(key,value,popUN_2015:popUN_2030) %>%
  mutate(growth_rate=(popUN_2030/popUN_2015)^(1/15)-1) %>% 
  ggplot(.) + 
  #geom_bar(aes(x=key,y=value),stat='identity') + 
  geom_bar(aes(x=size,y=growth_rate,fill=area),stat='identity') +
  facet_grid(.~area) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

data_proj %>% 
  filter(area=="WORLD") %>% 
  group_by(area) %>% 
  mutate(total_2015=sum(popUN_2015),total_2030=sum(popUN_2030)) %>% 
  ungroup() %>% 
  mutate(popUN_2015=popUN_2015/total_2015,popUN_2030=popUN_2030/total_2030) %>% 
  gather(key,value,popUN_2015:popUN_2030) %>% 
  ggplot(.) +
  geom_bar(aes(x=key,y=value,fill=size),stat='identity',position=position_stack(reverse = TRUE))

data_proj %>% 
  filter(area!="WORLD") %>% 
  ggplot(.) +
  geom_bar(aes(x=size,y=popUN_2015,fill=area),stat='identity') +
  facet_grid(.~area) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))



```

<hr>
### The structure of comparative research 
<br>

```{r include=FALSE}

rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")


## use agglomeration data if we have it
ctab <- left_join(ctab,data_UN, by = c("geo_city" = "City")) %>%
  select(-c(Year,Country,Record.Type,Reliability,Value.Footnotes))

ctab <- ctab %>%
  mutate(geo_pop=ifelse(UN_type=="Urban agglomeration" & is.na(UN_type)==FALSE,UN_pop,geo_pop))

ctab <- ctab %>%
  group_by(title) %>%
  mutate(comparative = ifelse(n()>1,1,0)) %>%
  select(geo_city:year,comparative,everything()) 

ctab$population_category <- cut(ctab$geo_pop,breaks = c(100e6,10e6,1e6,3e5,0),dig.lab=10,include.lowest=TRUE)

blarg <- ctab %>%
  filter(comparative==1)

blarg <- blarg %>% 
  filter(is.na(UN6)==FALSE) %>% 
  group_by(title,abstract) %>% 
  summarise(z=ifelse(length(unique(UN6))>1,1,0),regions=paste(UN6,collapse=";")) %>% 
  filter(z!=0)

# cxc <- ctab %>%
#   group_by(title,abstract) %>%
#   summarise(regions=paste(unique(UN6),collapse=";"),cities=paste(unique(geo_city),collapse=";"),comparative=first(comparative),
#             size=paste(unique(population_category),collapse='; '))
# 
# NAM <- sum(cxc$comparative[grep("NORTH AMERICA",cxc$regions)]==1)/length(grep("NORTH AMERICA",cxc$regions))
# AFR <- sum(cxc$comparative[grep("AFRICA",cxc$regions)]==1)/length(grep("AFRICA",cxc$regions))
# EUR <- sum(cxc$comparative[grep("EUROPE",cxc$regions)]==1)/length(grep("EUROPE",cxc$regions))
# ASI <- sum(cxc$comparative[grep("ASIA",cxc$regions)]==1)/length(grep("ASIA",cxc$regions))
# LAM <- sum(cxc$comparative[grep("LATIN AMERICA",cxc$regions)]==1)/length(grep("LATIN AMERICA",cxc$regions))
# 
# mega <- sum(cxc$comparative[grep("10000000,100000000",cxc$size)]==1)/length(grep("10000000,100000000",cxc$size))
# big <- sum(cxc$comparative[grep("1000000,10000000",cxc$size)]==1)/length(grep("1000000,10000000",cxc$size))
# medium <- sum(cxc$comparative[grep("300000,1000000",cxc$size)]==1)/length(grep("300000,1000000",cxc$size))
# small <- sum(cxc$comparative[grep("0,300000",cxc$size)]==1)/length(grep("0,300000",cxc$size))

names <- sort(unique(blarg$UN6))
comp <- matrix(data=0,nrow=length(names),ncol=length(names),dimnames=list(names,names))

blarg <- blarg %>%
  filter(is.na(UN6)==FALSE) %>%
  group_by(title,abstract) %>%
  summarise(regions=paste(UN6,collapse=";"),cities=paste(geo_city,collapse=";"),n=n()) %>%
  arrange(desc(n)) %>%
  filter(n!=1)




for (i in 1:length(blarg$title)) {

  temp_regs <- strsplit(blarg$regions[i],';')


  if (length(temp_regs[[1]])>1) {

    combos <- combn(temp_regs[[1]],2)

    for (j in 1:length(combos[1,])) {

      comp[combos[1,j],combos[2,j]] <- comp[combos[1,j],combos[2,j]] + 1
      comp[combos[2,j],combos[1,j]] <- comp[combos[2,j],combos[1,j]] + 1

    }
  }
}

ratio_comp <- comp

for (i in 1:length(ratio_comp[1,])) {
  
  ratio_comp[i,] <- ratio_comp[i,]/sum(ratio_comp[i,])
  
}

```

```{r comparative_Studies, echo=FALSE,warning=FALSE, rows.print=4, fig.path="Plots/",dev=c('png','pdf')}
library(chorddiag)
chorddiag(comp)
#chorddiag(ratio_comp)

#cxc <- cxc %>%
 # group_by(regions) %>%
  #summarise(n=sum(n()))

blarg %>%
  rename(city_count=n) %>% 
  group_by(city_count) %>% 
  summarise(study_count=n()) %>%  
  ggplot(.,aes(x=city_count,y=study_count)) +
  geom_bar(stat='identity')

```

# Topics by city and region


```{r include=FALSE}

rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")


# blarg <- gather(ctab,topic,value,"Air pollution":"Water demand") %>%
#   mutate(topic_count=ifelse(value>0.01,1,0)) %>%
#   group_by(UN6) %>%
#   mutate(total_score=sum(topic_count)) %>%
#   ungroup() %>%
#   group_by(UN6,topic) %>%
#   summarise(value=sum(topic_count)/first(total_score))

######### adjusted for global distribution ######### 

blarg <- gather(ctab,topic,value,"Air pollution":"Water demand") 
  #%>% mutate(value=ifelse(value>0.01,1,0))
global_topic_score = sum(blarg$value)

regions <- blarg %>%
  group_by(UN6) %>%
  filter(!is.na(UN6)) %>%
  mutate(total_score=sum(value)) %>%
  ungroup() %>%
  group_by(UN6,topic) %>%
  summarise(value=sum(value)/first(total_score))

regions2 <- blarg %>%
  group_by(topic) %>%
  filter(!is.na(UN6)) %>%
  mutate(global_topic_dist=sum(value)/global_topic_score) %>%
  group_by(UN6) %>%
  mutate(total_score=sum(value)) %>%
  ungroup() %>%
  group_by(UN6,topic) %>%
  summarise(value=log((sum(value)/first(total_score))/first(global_topic_dist)))

cities <- blarg %>%
  group_by(geo_city) %>%
  mutate(topic_score=sum(value)) %>%
  group_by(geo_city,topic) %>%
  summarise(value=sum(value)/first(topic_score),n=n()) %>%
  arrange(desc(n))

cities2 <- blarg %>%
  group_by(topic) %>%
  mutate(global_topic_dist=sum(value)/global_topic_score) %>%
  group_by(geo_city) %>%
  mutate(topic_score=sum(value)) %>%
  group_by(geo_city,topic) %>%
  summarise(value=log((sum(value)/first(topic_score))/first(global_topic_dist)),n=n()) %>%
  arrange(desc(n))


z <- cities %>%
  group_by(geo_city) %>%
  summarise(n=first(n)) %>%
  arrange(desc(n))

cities$city_ordered <- factor(cities$geo_city,levels=z$geo_city)
cities2$city_ordered <- factor(cities$geo_city,levels=z$geo_city)

```

```{r topic_distribution,echo=FALSE,warning=FALSE, fig.width=8,fig.height=6,fig.path="Plots/",dev=c('png','pdf')}


####################### no of studies per region and pop category #######################

regions %>%
  ggplot(.,aes(UN6,topic)) +
  geom_tile(aes(fill=value),colour="grey50") +
  scale_fill_distiller(palette = "YlGnBu",direction=1,na.value = "white") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("Summed topics, normalised by region")

regions2 %>%
  ggplot(.,aes(UN6,topic)) +
  geom_tile(aes(fill=value),colour="grey50") +
  scale_fill_distiller(palette = "YlGnBu",direction=1,na.value = "white") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("Summed topics, normalised by region and global distribution")

# cities <- cities %>%
#   group_by(topic) %>%
#   mutate(topic_average=mean(value))
#   
# top10 <- sort(unique(cities$topic_average),decreasing=TRUE)[11]
# 
# cities %>%
#   filter(topic_average>top10) %>%
#   ggplot(.,aes(city_ordered,topic)) +
#   geom_tile(aes(fill=value),colour="grey50") +
#   #scale_fill_gradient(low='white',high='#005a32',na.value = "grey") +
#   scale_fill_distiller(palette = "Blues",direction=1,na.value = "white") +
#   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

# cities2 %>%
#   ggplot(.,aes(city_ordered,topic)) +
#   geom_tile(aes(fill=value),colour="grey50") +
#   scale_fill_gradient2(low='#fc9272',mid='white',high='#005a32',midpoint=0,na.value = "grey") +
#   #scale_fill_distiller(palette = "PuOr",direction=1,na.value = "grey") +
#   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
#   ggtitle("Summed topics, normalised by city and global distribution")

topic_summary_summed <- regions %>%
  group_by(UN6) %>%
  arrange(desc(value)) %>%
  summarise(top_topics = paste0(c(nth(topic,1),nth(topic,2),nth(topic,3)),collapse="; "),low_topics = paste0(c(nth(topic,17),nth(topic,16),nth(topic,15)),collapse="; "))
  
topic_summary_normalised <- regions2 %>%
  group_by(UN6) %>%
  arrange(desc(value)) %>%
  summarise(top_topics = paste0(c(nth(topic,1),nth(topic,2),nth(topic,3)),collapse="; "),low_topics = paste0(c(nth(topic,17),nth(topic,16),nth(topic,15)),collapse="; "))

city_summary_summed <- cities %>%
  filter(n>40) %>%
  group_by(geo_city) %>%
  arrange(desc(value)) %>%
  summarise(n=first(n),top_topics=paste0(c(nth(topic,1),nth(topic,2),nth(topic,3)),collapse="; "),low_topics = paste0(c(nth(topic,17),nth(topic,16),nth(topic,15)),collapse="; ")) %>%
  arrange(desc(n))

africa_cities <- ctab %>%
  filter(geo_city=="Cairo") %>%
  gather(key="topic",value="value",`Air pollution`:`Water demand`) %>% 
  group_by(title,abstract) %>% 
  filter(value>0.025) %>% 
  mutate(topics=paste0(topic,collapse="; ")) %>% 
  summarise(geo_city=first(geo_city),year=first(year),topics=first(topics),authors=first(authors),doi=first(doi)) %>%
  arrange(desc(year)) %>% 
  select(title,year,authors,topics,doi)
  
library(xlsx)


topic_summary_normalised <- t(topic_summary_normalised)
topic_summary_summed <- t(topic_summary_summed)
city_summary_summed <- t(city_summary_summed)
#africa_cities <- t(africa_cities)

library(knitr)
library(kableExtra)
# kable(topic_summary_normalised, "html", caption="Normalised above/below average topics",digits=1) %>%
#   kable_styling() 

kable(topic_summary_summed, "html", caption="Summed top and bottom topics for regions",digits=1) %>%
  kable_styling()

kable(city_summary_summed, "html", caption="Summed top and bottom topics for cities",digits=1) %>%
  kable_styling()

kable(africa_cities, "html", caption="papers on Cairo",digits=1) %>%
  kable_styling()

write.xlsx(as.data.frame(africa_cities),file='Writing/cairo.xlsx')

```


```{r map,echo=FALSE,warning=FALSE,fig.width=10,fig.height=8,fig.path="Plots/",dev=c('png','pdf')}

#################### Maps ####################


rm(list = ls())
library(tidyverse)
library(ggmap)
library(maps)
library(mapdata)
library(xlsx)

load(file = "Data/city_studies.RData")

####################  get world map together ####################  

regions <- read.xlsx(file="C:\\Users\\lamw\\Google Drive\\Work\\Code\\MATLAB\\Data shop\\Region definitions\\regions.xls",sheetName = "Sheet1") %>%
  select(ISO.Code,IAM10,UN6)
regions$UN6 <- gsub("LATIN AMERICA AND THE CARIBBEAN","LATIN AMERICA",regions$UN6)
regions$UN6 <- gsub("NORTHERN AMERICA","NORTH AMERICA",regions$UN6)

isos <- read.xlsx(file="C:\\Users\\lamw\\Google Drive\\Work\\Code\\MATLAB\\Handy code\\ISOcodes.xls",sheetName="3 letter codes",startRow = 3,colIndex=7:8,header=FALSE)
names(isos) = c("country","iso")
isos <- isos %>% mutate(country=tolower(country))

world <- map_data("world") %>%
  filter(region != "Antarctica") %>%
  mutate(region=tolower(region))

world <- left_join(world,isos,by=c("region"="country"))
world <- left_join(world,regions,by=c("iso"="ISO.Code"))


####################  get city location data ####################  

blarg <- ctab %>%
  group_by(geo_city) %>%
  summarise(location=first(location),n=n(),UN6=first(UN6)) %>%
  mutate(location=str_extract(location,"\\([^()]+\\)")) %>%
  mutate(lat=as.numeric(str_extract(location,"([^(][0-9[[:punct:]]]+)[[:blank:]]"))) %>%
  mutate(long=as.numeric(str_extract(location,"([[:blank:]][0-9[[:punct:]]][^)]+)"))) %>%
  select(-location)


####################  plot ####################  


ggplot() + 
  geom_polygon(data = world, aes(x=long, y = lat, group = group, fill=UN6),color="white") + 
  theme_void() +
  coord_fixed(1) +
  geom_point(data=blarg,aes(x=lat,y=long,size=n,fill=UN6),color="black",fill="#636363",shape=21)








```

```{r include=FALSE}

########## deep diving

rm(list = ls())
library(tidyverse)
load(file = "Data/city_studies.RData")

### Africa buildings

AF <- ctab %>%
  filter(UN6=="AFRICA") %>%
  arrange(desc(Households))


EU <- ctab %>%
  filter(UN6=="EUROPE") %>%
  arrange(desc(Households))


```


```{r include=FALSE}

############## future looking cases ############## 


rm(list = ls())
library(tidyverse)
load(file = "Data/city_studies.RData")

ctab <- ctab %>%
  mutate(tags=ifelse(grepl("years",tags) || grepl("scenarios",tags),1,0))

futures_by_region <- ctab %>%
  group_by(UN6) %>%
  summarise(n=n(),futures=sum(tags)) %>%
  mutate(proportion=futures/n)

futures_by_topic <- ctab %>%
  gather(topic,value,'Air pollution':'Water demand') %>%
  group_by(topic) %>%
  mutate(total_value=sum(value)) %>%
  filter(tags==1) %>%
  group_by(topic) %>%
  summarise(total_value=nth(total_value,1),value=sum(value)) %>%
  mutate(proportion=value/total_value)


blarg <- ctab %>%
  mutate(tags=ifelse(grepl("years",tags) || grepl("scenarios",tags),1,0)) %>%
  filter(UN6=='AFRICA' & tags==1)

```
