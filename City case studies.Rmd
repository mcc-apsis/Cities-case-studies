---
title: "City case studies"
output: 
  html_document: 
    df_print: paged
    fig_width: 5
    fig_height: 3.5
---

<hr>
## The size bias of city case studies 
<br>

**Hypothesis**: There are more studies for cities of a larger size.

**Method**: Group cities by population size (>10m, 5-10m, 1-5m, 0.5-1m, 0.3-0.5m, <0.3m), sum and average the studies for each group.

**Data**: Database of urban papers, geonames database for city names and populations

```{r include=FALSE}

rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- ctab %>%
  group_by(geo_city,geo_country,geo_pop) %>%
  summarise(n=n()) %>%
  arrange(desc(n)) %>%
  mutate(geo_pop=as.numeric(geo_pop))

ctop <- left_join(ctop,data_UN, by = c("geo_city" = "City")) %>%
  select(-c(Year,Country,Record.Type,Reliability,Value.Footnotes)) %>%
  group_by(geo_city) %>%
  filter(UN_pop==max(UN_pop) | is.na(UN_pop)==TRUE)

ctop$population_category <- cut(ctop$geo_pop,breaks = c(100e6,10e6,5e6,1e6,5e5,3e5,0),dig.lab=10,include.lowest=TRUE)

blarg <- ctop %>%
  group_by(population_category,n==147,n==132,n==113,n==75,n==64,n==46,n==43) %>%
  summarise(no_cities=n(),mean_pop=mean(geo_pop),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(population_category))

blarg<- blarg %>%
  mutate(city_names=ifelse(nchar(blarg$city_names)>15,"Other",city_names))

ctop <- ctop %>%
  group_by(population_category) %>%
  summarise(no_cities=n(),mean_pop=mean(geo_pop),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>%
  ungroup() %>% arrange(desc(population_category))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(population_category,-mean_pop),y=mean_articles),stat="identity",fill="#2b8cbe") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m")) +
  xlab("Cities, grouped by population") +
  ylab("Average articles")

blarg %>%
  ggplot(.,aes(x=reorder(population_category,-mean_pop),y=sum_articles,fill=city_names)) +
  geom_bar(stat="identity") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m")) +
  xlab("Cities, grouped by population") +
  ylab("Total articles")

library(knitr)
library(kableExtra)
kable(ctop, "html", caption="Urban studies versus population",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")

```



```{r echo=FALSE,warning=FALSE, rows.print=4}

### Medium and small cities dominate population projections 

# data_proj %>%
#   filter(area=="WORLD",type=="Population",year>2010) %>%
#   arrange(-desc(size_code)) %>%
#   ggplot(.,aes(x=year,y=value,fill=size)) +
#   geom_bar(stat='identity') +
#   scale_fill_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m"))

```


```{r echo=FALSE,warning=FALSE, rows.print=4}

### Case studies pretty well reflect the population projections

# ctop$population_category <- factor(ctop$population_category, levels=rev(levels(ctop$population_category)))
# ctop %>%
#   mutate(Articles="") %>%
#   ggplot(.,aes(x=Articles,y=sum_articles,fill=population_category)) +
#   geom_bar(stat='identity') +
#   scale_fill_discrete(labels = c(">10m","5-10m","1-5m","0.5-1m","0.3-0.5m","<0.3m"))


```
<hr>
### But case studies are geographically concentrated in Europe and North America
<br>

```{r include=FALSE}


rm(list = ls())
library(tidyverse)
library(svglite)
library(xlsx)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")
load(file="Data/geo_data.RData")


######### merge studies into regional breakdown of cities and populations ######### 

ctab$population_category <- cut(ctab$geo_pop,breaks=c(100e6,10e6,5e6,1e6,5e5,3e5,1),dig.lab=10,include.lowest=TRUE,ordered_result = TRUE)
  
ctab <- ctab %>%
  group_by(IAM10) %>%
  mutate(region_studies=sum(n())) %>%
  group_by(IAM10,population_category) %>%
  summarise(no_studies=n(),study_cities=length(unique(geo_city)),study_city_names=paste(unique(geo_city), collapse=", "),study_norm=sum(n())/first(region_studies)) %>%
  complete(population_category)

data_geo$population_category <- cut(data_geo$pop,breaks=c(100e6,10e6,5e6,1e6,5e5,3e5,1),dig.lab=10,include.lowest=TRUE,ordered_result = TRUE)

data_geo <- data_geo %>%
  group_by(IAM10) %>%
  mutate(region_pop=sum(pop)) %>%
  ungroup() %>%
  group_by(IAM10,population_category) %>%
  summarise(geo_cities=n(),geo_city_names=paste(city, collapse=", "),geo_pop=sum(pop),geo_norm_pop=sum(pop)/mean(region_pop)) %>%
  complete(population_category)


blarg <- left_join(ctab,data_geo)

zz <- blarg %>%
  group_by(population_category) %>%
  summarise(geo_pop = sum(geo_pop,na.rm=TRUE),no_studies=sum(no_studies,na.rm=TRUE)) %>%
  mutate(IAM10="WORLD") %>%
  group_by(IAM10) %>%
  mutate(total_studies=sum(no_studies),total_pop=sum(geo_pop)) %>%
  ungroup() %>%
  mutate(study_norm=no_studies/total_studies,geo_norm_pop=geo_pop/total_pop) %>%
  select(-c(total_studies,total_pop))

blarg <- full_join(blarg,zz)

```
```{r echo=FALSE,warning=FALSE, fig.width=7, fig.height=5}


####################### no of studies per region and pop category #######################

ctab %>%
  ggplot(.,aes(x=IAM10,y=population_category)) +
  geom_tile(aes(fill=no_studies),colour="grey50") +
  scale_fill_distiller(palette = "Blues",direction=1,na.value = "white") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("City population category") +
  xlab("Region")

```

<hr>
### And case studies regionally mis-match the population breakdown of cities
<br>


```{r echo=FALSE,warning=FALSE, fig.width=12, fig.height=5}

####################### regional focus of research vs. breakdown of city populations #######################

blarg$population_category <- factor(blarg$population_category, levels=rev(levels(blarg$population_category)))

blarg <- blarg %>%
  filter(is.na(IAM10)==FALSE) %>%
  mutate(norm_region_pop = geo_norm_pop,norm_study_count = study_norm) %>%
  gather(key = "key", value = "value",c(norm_study_count,norm_region_pop))

blarg %>%
  ggplot(.,aes(x=key,y=value,fill=population_category)) +
  geom_bar(stat='identity') +
  facet_grid(.~IAM10) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

```

<hr>
### This probably reflects a general wealth bias that we see from the (limited) available income data of cities
<br>

```{r include=FALSE}

rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- ctab %>%
  group_by(geo_city,geo_country,geo_pop) %>%
  summarise(n=n()) %>%
  arrange(desc(n)) %>%
  mutate(geo_pop=as.numeric(geo_pop))

ctop <- left_join(ctop,data_income, by = c("geo_city" = "City")) 

ctop$gdp_pc = cut(ctop$value,breaks = c(round(quantile(data_income$value),-3)),include.lowest=TRUE,dig.lab=10)

blarg <- ctop %>%
  group_by(gdp_pc,n==147,n==132,n==113,n==75,n==64,n==46,n==43) %>%
  summarise(no_cities=n(),mean_gdp=mean(value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(gdp_pc))

blarg<- blarg %>%
  mutate(city_names=ifelse(nchar(blarg$city_names)>15,"Other",city_names))

ctop <- ctop %>%
  group_by(gdp_pc) %>% 
  summarise(no_cities=n(),mean_gdp=mean(value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(geo_city, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(gdp_pc))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(gdp_pc,-mean_gdp),y=mean_articles),stat="identity",fill="#2b8cbe") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Average articles")

blarg %>%
  ggplot(.,aes(x=reorder(gdp_pc,-mean_gdp),y=sum_articles,fill=city_names)) +
  geom_bar(stat="identity") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Total articles")

kable(ctop, "html", caption="Urban studies versus GDP",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```

### Older plots...

```{r include=FALSE}

######### heatmap by region, wealth, studies #########

# ctab$income_category <- cut(ctab$income,breaks = c(round(quantile(data_income$value),-3)),include.lowest=TRUE,dig.lab=10)

# for incomplete data  
# ctab[is.na(ctab$population_category),]$population_category <- "Unknown Pop"
# ctab$population_category <- factor(ctab$population_category, exclude=NULL)
# ctab$income_category <- cut(ctab$income,breaks = c(round(quantile(data_income$value),-3)),include.lowest=TRUE,dig.lab=10)



rm(list = ls())
library(tidyverse)
library(svglite)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")


# Rank cities by no. papers
ctab %>%
  group_by(geo_city,geo_country) %>%
  summarise(n=n()) %>%
  arrange(desc(n)) %>%
  filter(n>10) %>%
  ggplot(.,aes(x=reorder(geo_city,-n),y=n)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))


```


<br><br>
