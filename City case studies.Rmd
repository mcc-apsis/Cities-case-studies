---
title: "City case studies"
output: 
  html_document: 
    df_print: paged
    fig_width: 5
    fig_height: 3.5
---

<hr>
## The size bias of city case studies 
<br>

**Hypothesis**: There are more studies for cities of a larger size.

**Method**: Group cities by population size (>10m, 5-10m, 1-5m, <1m), sum and average the studies for each group.

**Data**: Database of urban papers, population data for cities from the UN.

**Results**: Hypothesis is correct for average and total articles per population bracket.

```{r include=FALSE}

rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(reshape2)
library(svglite)
library(fuzzyjoin)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- left_join(ctop,data_UN, by = c("vars" = "City")) %>%
  group_by(vars) %>%
  filter(Value==max(Value) | is.na(Value)==TRUE)

ctop$population_category <- cut(ctop$Value,breaks = c(100e6,10e6,5e6,1e6,1e5),dig.lab=10,include.lowest=TRUE)
ctop <- ctop %>%
  group_by(population_category) %>%
  summarise(no_cities=n(),mean_pop=mean(Value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(vars, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(population_category))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(population_category,-mean_articles),y=mean_articles),stat="identity",fill="#2b8cbe") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","<1m","NA")) +
  xlab("Cities, grouped by population") +
  ylab("Average articles")

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(population_category,-sum_articles),y=sum_articles),stat="identity",fill="#2b8cbe") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","<1m","NA")) +
  xlab("Cities, grouped by population") +
  ylab("Total articles")


library(knitr)
library(kableExtra)
kable(ctop, "html", caption="Urban studies versus population",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```


<br>
<hr>
## The wealth bias of city case studies 
<br>

**Hypothesis**: There are more studies for wealthier cities.

**Method**: Group cities by income classification (quantiles of global urban income), sum and average the studies for each group.

**Data**: Database of urban papers, income data from GEA and OECD.

**Results**: Hypothesis is correct, but with an uptick of studies in the lowest income bracket. These are mainly accounted for by Beijing and Shanghai.
<br>


```{r include=FALSE}

rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(reshape2)
library(svglite)
library(fuzzyjoin)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- left_join(ctop,data_income, by = c("vars" = "cities")) 

ctop <- ctop %>%
  group_by(gdp_pc = cut(ctop$value,breaks = c(round(quantile(data_income$value),-3)),include.lowest=TRUE,dig.lab=10)) %>% 
  summarise(no_cities=n(),mean_gdp=mean(value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(vars, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(gdp_pc))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(gdp_pc,-mean_gdp),y=mean_articles),stat="identity",fill="#2b8cbe") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Average articles")

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(gdp_pc,-mean_gdp),y=sum_articles),stat="identity",fill="#2b8cbe") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Total articles")


kable(ctop, "html", caption="Urban studies versus GDP",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```
<br>
<hr>
## Topics by region, key cities
<br>


```{r include=FALSE}


rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(reshape2)
library(svglite)
library(fuzzyjoin)
library(xlsx)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

######### merge it all into one giant mess ######### 
data_UN <- data_UN %>%
  select(Country,City,Value,City.type) %>%
  group_by(City) %>%
  filter(Value==max(Value))

ctab <- left_join(ctab,data_UN,by= c("cities"="City"))
ctab <- ctab %>% 
  rename(pop=Value,country_UN=Country,country_own=country,city_pop_type=City.type)
ctab <- left_join(ctab,data_income)
ctab <- ctab %>%
  rename(income_source=gdp,income=value)
  
######### Merge country and region names ######### 

regions <- read.xlsx(file="C:\\Users\\lamw\\Google Drive\\Work\\Code\\MATLAB\\Data shop\\Region definitions\\regions.xls",sheetName = "Sheet1") %>%
  select(ISO.Code,IAM10)

df_isos <- read.xlsx(file="C:\\Users\\lamw\\Google Drive\\Work\\Code\\MATLAB\\Handy code\\ISOcodes.xls",
                  sheetName="3 letter codes",colIndex=7:8,startRow=3,header=FALSE,encoding="UTF-8") %>%
  rename(countries=X7,isos=X8) %>%
  filter(!countries %in% c("US","World","Jersey"),!isos %in% c("ZZZZ","ZZZA")) %>%
  mutate(countries=tolower(countries),isos=as.character(isos))

ctab <- ctab %>%
  mutate(country_UN=tolower(country_UN)) %>%
  left_join(df_isos,by=c("country_UN"="countries"))

# where countries are missing, use earlier abstract-search
ctab$isos[is.na(ctab$isos)] <- ctab$country_own[is.na(ctab$isos)]

ctab <- ctab %>%
  left_join(regions,by=c("isos"="ISO.Code")) %>%
  select(cities,country_own,country_UN,isos,IAM10,pop,income,everything())


```
```{r echo=FALSE,warning=FALSE, fig.width=7, fig.height=5}


######### group by region and summarise #########
ctab %>%
  gather(topic,value,Active.travel:e.Vehicles) %>%
  group_by(IAM10,topic) %>%
  summarise(no_studies=n(),no_cities=length(unique(cities)),value=mean(value)) %>%
  
  ggplot(., aes(IAM10,topic)) +
  geom_tile(aes(fill = value),colour = "white") +
  scale_fill_gradient(low = "white",high = "steelblue") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

######### set thresholds ######### 
ctab$pop_category <- cut(ctab$pop,breaks = c(100e6,10e6,5e6,1e6,1e5),include.lowest=TRUE,dig.lab=10)
ctab$income_category <- cut(ctab$income,breaks = c(round(quantile(data_income$value),-3)),include.lowest=TRUE,dig.lab=10)


# Rank cities by no. papers
ctab %>%
  group_by(cities,isos) %>%
  summarise(n=n()) %>%
  arrange(desc(n)) %>%
  filter(n>10) %>%
  ggplot(.,aes(x=reorder(cities,-n),y=n)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))


```


<br><br>
