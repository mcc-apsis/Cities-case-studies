---
title: "City case studies"
output: 
  html_document: 
    df_print: paged
    fig_width: 5
    fig_height: 3.5
---

<hr>
## The size bias of city case studies 
<br>

**Hypothesis**: There are more studies for cities of a larger size.

**Method**: Group cities by population size (>10m, 5-10m, 1-5m, <1m), sum and average the studies for each group.

**Data**: Database of urban papers, population data for cities from the UN.

**Results**: Hypothesis is correct for average and total articles per population bracket.

```{r include=FALSE}

rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(reshape2)
library(svglite)
library(fuzzyjoin)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

ctop <- left_join(ctop,data_UN, by = c("vars" = "City")) %>%
  group_by(vars) %>%
  filter(Value==max(Value) | is.na(Value)==TRUE)

ctop$population_category <- cut(ctop$Value,breaks = c(100e6,10e6,5e6,1e6,1e5),dig.lab=10,include.lowest=TRUE)
ctop <- ctop %>%
  group_by(population_category) %>%
  summarise(no_cities=n(),mean_pop=mean(Value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(vars, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(population_category))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(population_category,-mean_articles),y=mean_articles),stat="identity",fill="#2b8cbe") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","<1m","NA")) +
  xlab("Cities, grouped by population") +
  ylab("Average articles")

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(population_category,-sum_articles),y=sum_articles),stat="identity",fill="#2b8cbe") +
  scale_x_discrete(labels = c(">10m","5-10m","1-5m","<1m","NA")) +
  xlab("Cities, grouped by population") +
  ylab("Total articles")


library(knitr)
library(kableExtra)
kable(ctop, "html", caption="Urban studies versus population",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```


<br>
<hr>
## The wealth bias of city case studies 
<br>

**Hypothesis**: There are more studies for wealthier cities.

**Method**: Group cities by income classification (quantiles of global urban income), sum and average the studies for each group.

**Data**: Database of urban papers, income data from GEA and OECD.

**Results**: Hypothesis is correct, but with an uptick of studies in the lowest income bracket. These are mainly accounted for by Beijing and Shanghai.
<br>


```{r include=FALSE}

rm(list = ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(reshape2)
library(svglite)
library(fuzzyjoin)

load(file = "Data/city_studies.RData")
load(file = "Data/city_data.RData")

######## merge GDP datasets (not normalised! preference for GEA data) ######## 

income_data <- data_GEA %>%
  rename(GEA_income="gdp_per_cap") %>%
  select(cities,GEA_income)

income_data <- full_join(income_data,data_OECD) %>%
  rename(OECD_income="value") %>%
  select(-c(year,unit))

#ctop %>%
 # ggplot(.) +
  #geom_point(aes(x=GEA_income,y=OECD_income))

income_data <- income_data %>%
  gather(gdp,value,GEA_income,OECD_income) %>%
  group_by(cities) %>%
  filter(is.na(value)==FALSE) %>%
  filter(row_number()==1)


######## join 

ctop <- left_join(ctop,income_data, by = c("vars" = "cities")) 

ctop <- ctop %>%
  group_by(gdp_pc = cut(ctop$value,breaks = c(round(quantile(income_data$value),-3)),include.lowest=TRUE,dig.lab=10)) %>% 
  summarise(no_cities=n(),mean_gdp=mean(value),sum_articles=sum(n),mean_articles=mean(n),city_names=paste(vars, collapse=", ")) %>% 
  ungroup() %>% arrange(desc(gdp_pc))


```
```{r echo=FALSE,warning=FALSE, rows.print=4}

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(gdp_pc,-mean_gdp),y=mean_articles),stat="identity",fill="#2b8cbe") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Average articles")

ctop %>%
  ggplot(.) +
  geom_bar(aes(x=reorder(gdp_pc,-mean_gdp),y=sum_articles),stat="identity",fill="#2b8cbe") +
  #scale_x_discrete(labels = c(">$20k","$12k-$20k","$5k-$12k","NA")) +
  xlab("Cities, grouped by GDP per capita") +
  ylab("Total articles")


kable(ctop, "html", caption="Urban studies versus GDP",digits=1) %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```

<br><br>
